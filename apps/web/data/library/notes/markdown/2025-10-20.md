# Phase 4 Implementation Summary: UI Components

## Overview
Phase 4 successfully implements the user interface layer for the annotation notes & asset attachment system. Users can now create notes (markdown or file uploads), attach them to annotations, and manage them directly from the annotation editor.

## Components Created

### 1. CreateNoteDialog.tsx (311 lines)
**Location:** `/frontend/app/reader/CreateNoteDialog.tsx`

**Purpose:** Modal dialog for creating/uploading notes and attaching them to annotations

**Features:**
- **Mode Toggle:** Switch between markdown creation and file upload
- **Markdown Mode:**
  - Title input (required, trimmed)
  - Content textarea with auto-resize
  - Creates `.md` files via `/api/library/create-markdown`
- **Upload Mode:**
  - Drag-and-drop zone with visual feedback (hover/drag-over states)
  - File type validation (markdown, PDF, PNG, JPG, WebP)
  - Size validation (10MB max)
  - Uploads via `/api/library/upload` with multipart/form-data
- **Error Handling:** Displays API errors to user
- **Loading States:** Disables buttons and shows spinners during operations
- **Auto-attachment:** Automatically creates Asset and attaches to annotation

**Props:**
```typescript
interface CreateNoteDialogProps {
  annotationId: string;      // Annotation to attach note to
  onClose: () => void;        // Close dialog callback
  onNoteCreated: () => void;  // Success callback (triggers reload)
}
```

**API Integration:**
- `POST /api/library/create-markdown` - Creates markdown blobs
- `POST /api/library/upload` - Uploads binary files
- `createNoteAsset()` - Creates Asset in Dexie with role="notes"
- `attachAssetToAnnotation()` - Links Asset to Annotation

### 2. NotePreview.tsx (163 lines)
**Location:** `/frontend/app/reader/NotePreview.tsx`

**Purpose:** Display component for note assets with appropriate previews

**Features:**
- **Markdown Rendering:**
  - Fetches content from `/api/blob/{sha256}`
  - Renders with ReactMarkdown + remark-gfm + remark-math + rehype-katex
  - Full math equation support (inline and block)
  - Loading and error states
- **Image Preview:**
  - Inline display with rounded borders
  - Max-width responsive sizing
  - Error handling for broken images
- **PDF Display:**
  - Icon preview with file size
  - External link to open in new tab (`/api/blob/{sha256}`)
- **File Info:**
  - Icon based on MIME type (markdown=purple, image=blue, PDF=red)
  - Title from metadata or filename
  - Formatted file size (B, KB, MB)
- **Delete Button:** Calls `onDelete` callback with confirmation

**Props:**
```typescript
interface NotePreviewProps {
  asset: Asset;              // Asset to preview
  onDelete?: () => void;     // Optional delete callback
}
```

**Dependencies:**
- `react-markdown` - Markdown rendering
- `remark-gfm` - GitHub Flavored Markdown
- `remark-math` + `rehype-katex` - Math equation support
- `lucide-react` - Icons

### 3. AnnotationEditor.tsx (Modified)
**Location:** `/frontend/app/reader/AnnotationEditor.tsx`

**Changes:**
- **New Imports:**
  - `Asset` type from library schema
  - `Plus` icon from lucide-react
  - `deleteNoteAsset` from assets repository
  - `CreateNoteDialog` and `NotePreview` components
  
- **New State:**
  ```typescript
  const [attachedNotes, setAttachedNotes] = useState<Asset[]>([]);
  const [notesLoading, setNotesLoading] = useState(false);
  const [showNoteDialog, setShowNoteDialog] = useState(false);
  ```

- **New Functions:**
  - `loadAttachedNotes()` - Fetches attached assets via `getAnnotationAssets()`
  - `handleDeleteNote()` - Deletes asset and reloads notes
  - `handleNoteCreated()` - Closes dialog and reloads notes

- **New UI Section:** "Attached Notes"
  - Placed after Tags section, before Highlight Text
  - Header with "Add Note" button (opens CreateNoteDialog)
  - Loading state during fetch
  - Empty state with dashed border
  - List of NotePreview components with delete handlers

- **Integration Points:**
  - Loads notes when annotation changes (in `useEffect`)
  - Reloads notes after creation/deletion
  - Dialog rendered conditionally at bottom of component

## User Flow

### Creating a Note
1. User selects annotation in PDF
2. AnnotationEditor opens in right sidebar
3. User clicks "Add Note" in "Attached Notes" section
4. CreateNoteDialog appears as modal overlay
5. User chooses mode:
   - **Markdown:** Enters title + content → Creates `.md` file
   - **Upload:** Drags/selects file → Validates → Uploads
6. System creates Asset in Dexie with:
   - `role: "notes"`
   - `purpose: "annotation-note"`
   - `annotationId: <target-annotation-id>`
7. System attaches Asset UUID to `annotation.metadata.attachedAssets[]`
8. Dialog closes, notes section reloads
9. New note appears in NotePreview list

### Viewing Notes
1. User selects annotation
2. AnnotationEditor loads attached notes via `getAnnotationAssets()`
3. Each note renders as NotePreview:
   - **Markdown:** Fetches content, renders with math support
   - **Images:** Displays inline preview
   - **PDFs:** Shows icon + "Open PDF" link
4. File info displays at top (icon, title, size)

### Deleting Notes
1. User clicks trash icon on NotePreview
2. System calls `deleteNoteAsset(assetId)`:
   - Removes UUID from `annotation.metadata.attachedAssets[]`
   - Deletes Asset from Dexie
   - (CAS blob remains for deduplication)
3. Notes section reloads
4. Deleted note disappears from list

## File Organization

Notes are stored in organized CAS structure:
```
data/library/
├── notes/
│   ├── markdown/
│   │   └── <sha256>.md
│   ├── images/
│   │   └── <sha256>.<ext>
│   └── pdfs/
│       └── <sha256>.pdf
```

Role-based paths determined by `getStoragePathForRole()` in `cas.ts`.

## Validation & Security

### File Upload Validation
- **Size Limit:** 10MB max (enforced in API route)
- **MIME Types:** Whitelist in upload endpoint
  - `text/markdown`
  - `application/pdf`
  - `image/png`
  - `image/jpeg`
  - `image/webp`
- **Filename Sanitization:** Applied in CAS storage

### Markdown Validation
- Title required and trimmed (prevents empty strings)
- Content required and trimmed
- Filename generated from title with `.md` extension

### Circular Reference Prevention
- Assets with `role="notes"` cannot have `role="notes"` attached
- Enforced at schema level via AssetRoleSchema

## Dependencies

### New Runtime Dependencies
All already installed in project:
- `react-markdown@^9.0.1` - Markdown rendering
- `remark-gfm@^4.0.0` - GitHub Flavored Markdown (tables, strikethrough, etc.)
- `remark-math@^6.0.0` - Math equation parsing
- `rehype-katex@^7.0.0` - KaTeX math rendering
- `lucide-react@^0.468.0` - Icon components

### Type Dependencies
- `@/src/schema/annotation` - Annotation type
- `@/src/schema/library` - Asset type

## Testing Checklist

### CreateNoteDialog
- [ ] Opens when "Add Note" clicked
- [ ] Mode toggle switches between markdown/upload
- [ ] Markdown: title validation (required, trimmed)
- [ ] Markdown: content validation (required, trimmed)
- [ ] Markdown: creates .md file and attaches to annotation
- [ ] Upload: drag-drop zone accepts files
- [ ] Upload: rejects files >10MB
- [ ] Upload: rejects invalid MIME types
- [ ] Upload: shows error messages
- [ ] Upload: creates Asset and attaches to annotation
- [ ] Close button works
- [ ] Success triggers note reload in editor

### NotePreview
- [ ] Markdown: fetches content from blob API
- [ ] Markdown: renders with GFM support (tables, links, etc.)
- [ ] Markdown: renders math equations (inline and block)
- [ ] Images: displays inline preview
- [ ] Images: handles load errors gracefully
- [ ] PDFs: shows icon and "Open PDF" link
- [ ] PDFs: link opens in new tab
- [ ] File info displays correctly (icon, title, size)
- [ ] Delete button calls onDelete callback

### AnnotationEditor Integration
- [ ] Loads attached notes when annotation selected
- [ ] Shows loading state while fetching notes
- [ ] Shows empty state when no notes attached
- [ ] Displays all attached notes in list
- [ ] "Add Note" button opens dialog
- [ ] Delete note removes from list and reloads
- [ ] Creating note adds to list and reloads
- [ ] Notes persist after closing/reopening annotation

### Edge Cases
- [ ] Multiple notes on same annotation
- [ ] Same file attached to multiple annotations (deduplication)
- [ ] Deleted annotation cleans up attached assets
- [ ] Large markdown files (>100KB)
- [ ] Markdown with embedded images (via ![](url))
- [ ] Unicode filenames
- [ ] Very long note titles (truncation)

## Next Steps: Phase 5 (Reader Integration)

The backend and UI components are now complete. Phase 5 will integrate notes into the PDF reading experience:

1. **NoteSidebar Component**
   - Floating panel alongside PDF
   - Lists notes for current page
   - Scroll sync with PDF

2. **Visual Connectors**
   - SVG lines linking annotations to notes
   - Dynamic positioning based on annotation overlays
   - Hover states for highlighting connections

3. **Drag-Drop on Overlays**
   - Drop files directly on annotation overlays
   - Bypasses dialog for quick attachment
   - Visual feedback during drag-over

4. **Keyboard Shortcuts**
   - `N` - Create note for selected annotation
   - `Shift+N` - Open notes sidebar
   - `Delete` - Remove selected note

See Phase 5 design in main implementation guide for detailed specs.

## Performance Considerations

- **Lazy Loading:** Markdown content fetched on-demand (not preloaded)
- **Image Optimization:** Native browser lazy loading for `<img>` tags
- **Batched Queries:** `getAnnotationAssets()` uses `.anyOf()` for efficient lookups
- **Memoization:** NotePreview renders could be memoized if performance issues arise
- **Debouncing:** Consider debouncing note creation API calls if users spam "Add Note"

## Known Limitations

1. **No Inline Editing:** Must delete and recreate to edit markdown notes
   - Future: Add edit mode to NotePreview with inline textarea
2. **No Reordering:** Notes display in creation order
   - Future: Add drag-drop reordering with custom sort field
3. **No Search:** Can't search within attached notes
   - Future: Add search bar in "Attached Notes" section
4. **No Thumbnails for PDFs:** Shows icon instead of first page preview
   - Future: Generate thumbnails on upload with canvas API
5. **No Rich Text Editor:** Plain textarea for markdown
   - Future: Integrate CodeMirror or Monaco for syntax highlighting

## Success Metrics

Phase 4 successfully delivers:
- ✅ 3 new components (CreateNoteDialog, NotePreview, AnnotationEditor integration)
- ✅ 600+ lines of production UI code
- ✅ Full CRUD lifecycle (Create, Read, Delete) for note attachments
- ✅ Dual input methods (markdown + file upload)
- ✅ Multi-format preview support (markdown, images, PDFs)
- ✅ Error handling and loading states throughout
- ✅ Type-safe integration with existing annotation system
- ✅ Zero compilation errors

Users can now:
1. Attach notes to any annotation
2. Upload Goodnotes PDFs alongside highlights
3. Write markdown notes with math equations
4. View attached notes directly in annotation editor
5. Delete notes with one click

This completes the core functionality for the annotation notes & asset attachment feature. Phase 5 will enhance the reading experience with visual polish and advanced interactions.
