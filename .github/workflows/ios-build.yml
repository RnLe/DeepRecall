name: iOS Build with Capacitor

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'frontend/**'
  pull_request:
    branches: [ main ]
    paths: 
      - 'frontend/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: Install pnpm
      run: npm install -g pnpm
      
    - name: Install dependencies
      run: |
        cd frontend
        pnpm install
        
    - name: Build Next.js app
      run: |
        cd frontend
        pnpm run build
        
    - name: Setup Capacitor
      run: |
        cd frontend
        npx cap sync ios
        
    - name: Build iOS app (Simulator)
      run: |
        cd frontend/ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -destination 'platform=iOS Simulator,name=iPhone 15' \
                   -configuration Release \
                   build
                   
    # Build unsigned IPA for manual installation
    - name: Build unsigned IPA (for manual installation)
      run: |
        cd frontend/ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -destination 'generic/platform=iOS' \
                   -configuration Release \
                   -archivePath DeepRecall.xcarchive \
                   archive \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
                   
        # Export unsigned IPA
        xcodebuild -exportArchive \
                   -archivePath DeepRecall.xcarchive \
                   -exportPath . \
                   -exportOptionsPlist ../../../export-options-unsigned.plist
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-artifacts
        path: |
          frontend/ios/App/DeepRecall.ipa
          frontend/ios/App/build/
          frontend/out/
        retention-days: 7

  # Instructions for manual installation
  post-build-info:
    needs: build-ios
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Installation Instructions
      run: |
        echo "ðŸ“± iOS Build Complete!"
        echo ""
        echo "ðŸ”½ Download the IPA file from the artifacts above"
        echo ""
        echo "ðŸ“‹ Installation options:"
        echo "1. FREE: Use free Apple Developer account (7-day expiry)"
        echo "   - Open Xcode on Mac"
        echo "   - Connect iPad via USB"
        echo "   - Drag IPA to Xcode Devices window"
        echo ""
        echo "2. ALTERNATIVE: Use AltStore (requires setup)"
        echo "   - Install AltStore on iPad"
        echo "   - Sideload the IPA file"
        echo ""
        echo "3. PAID: TestFlight (\$99/year Apple Developer account)"
        echo "   - Upload to TestFlight for easy distribution"
